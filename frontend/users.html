<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Utilisateurs - Propelize</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f5f5f5; }
    button { padding: 5px 10px; cursor: pointer; }
    #newUserForm, #editUserForm { margin-top: 20px; display: none; }
    .hidden { display: none; }
    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 4px; }
    input { width: 100%; padding: 8px; box-sizing: border-box; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title"></h1>
    <div id="profileSection" class="hidden"></div>
    <div id="adminSection" class="hidden">
      <h2>Liste des utilisateurs</h2>
      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th><th>Nom</th><th>Rôle</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button onclick="toggleForm('newUserForm')">Créer un nouvel utilisateur</button>
      <form id="newUserForm">
        <div class="form-group">
          <label for="newName">Nom</label>
          <input type="text" id="newName" required />
        </div>
        <div class="form-group">
          <label for="newPassword">Mot de passe</label>
          <input type="password" id="newPassword" required />
        </div>
        <div class="form-group">
          <label for="newRole">Rôle</label>
          <select id="newRole">
            <option value="user">Utilisateur</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit">Créer</button>
      </form>

      <form id="editUserForm">
        <h3>Modifier l'utilisateur</h3>
        <input type="hidden" id="editId" />
        <div class="form-group">
          <label for="editName">Nom</label>
          <input type="text" id="editName" required />
        </div>
        <div class="form-group">
          <label for="editRole">Rôle</label>
          <select id="editRole">
            <option value="user">Utilisateur</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit">Mettre à jour</button>
      </form>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3001';
    const token = localStorage.getItem('accessToken');
    const user = JSON.parse(localStorage.getItem('user'));

    document.addEventListener("DOMContentLoaded", () => {
      if (!user || !token) return location.href = '/login.html';
      document.getElementById("title").textContent = `Bienvenue, ${user.name}`;

      if (user.role === 'admin') {
        document.getElementById("adminSection").classList.remove("hidden");
        loadUsers();
        document.getElementById("newUserForm").addEventListener("submit", createUser);
        document.getElementById("editUserForm").addEventListener("submit", updateUser);
      } else {
        document.getElementById("profileSection").classList.remove("hidden");
        document.getElementById("profileSection").innerHTML = `<h2>Mon profil</h2><p>Nom : ${user.name}</p><p>Rôle : ${user.role}</p>`;
      }
    });

    function toggleForm(id) {
      const form = document.getElementById(id);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    async function loadUsers() {
      const res = await fetch(`${API}/users`, { headers: { Authorization: `Bearer ${token}` } });
      const users = await res.json();
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = '';
      users.forEach(u => {
        tbody.innerHTML += `<tr>
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.role}</td>
          <td>
            <button onclick="populateEdit(${u.id}, '${u.name}', '${u.role}')">Modifier</button>
            <button onclick="deleteUser(${u.id})">Supprimer</button>
          </td>
        </tr>`;
      });
    }

    async function deleteUser(id) {
      if (!confirm("Supprimer cet utilisateur ?")) return;
      await fetch(`${API}/users/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });
      loadUsers();
    }

    function populateEdit(id, name, role) {
      document.getElementById("editId").value = id;
      document.getElementById("editName").value = name;
      document.getElementById("editRole").value = role;
      document.getElementById("editUserForm").style.display = 'block';
    }

    async function updateUser(e) {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      const name = document.getElementById("editName").value;
      const role = document.getElementById("editRole").value;

      await fetch(`${API}/users/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ name, role })
      });

      loadUsers();
      document.getElementById("editUserForm").reset();
      document.getElementById("editUserForm").style.display = 'none';
    }

    async function createUser(e) {
      e.preventDefault();
      const name = document.getElementById("newName").value;
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;

      await fetch(`${API}/users`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ name, password, role })
      });

      loadUsers();
      document.getElementById("newUserForm").reset();
      document.getElementById("newUserForm").style.display = 'none';
    }
  </script>
</body>
</html>

