<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Propelize - Connexion</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #4361ee, #4cc9f0);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      font-family: 'Roboto', sans-serif;
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .bubbles {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 0;
      overflow: hidden;
      top: 0;
      left: 0;
    }
    
    .bubble {
      position: absolute;
      bottom: -100px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: rise 10s infinite ease-in;
    }
    
    @keyframes rise {
      0% {
        bottom: -100px;
        transform: translateX(0);
      }
      50% {
        transform: translateX(100px);
      }
      100% {
        bottom: 1080px;
        transform: translateX(-200px);
      }
    }
    
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      z-index: 1;
      transition: all 0.5s ease;
    }
    
    .container.hidden {
      display: none;
      opacity: 0;
      transform: translateY(20px);
    }
    
    .container.visible {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      margin-bottom: 2rem;
      opacity: 0.9;
    }
    
    .input-group {
      margin-bottom: 1.5rem;
      text-align: left;
      position: relative;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .input-group .icon {
      position: absolute;
      left: 15px;
      top: 40px;
      font-size: 1.2rem;
    }
    
    .input-group input, 
    .input-group select {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .input-group input:focus, 
    .input-group select:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
    }
    
    .input-group input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .remember-forgot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .remember {
      display: flex;
      align-items: center;
    }
    
    .remember input {
      margin-right: 8px;
    }
    
    .forgot-password, 
    .signup-link a, 
    .login-link a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .forgot-password:hover, 
    .signup-link a:hover, 
    .login-link a:hover {
      text-decoration: underline;
      opacity: 0.9;
    }
    
    .btn-login, 
    .btn-signup {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: white;
      color: #4361ee;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 1.5rem;
    }
    
    .btn-login:hover, 
    .btn-signup:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn-login:disabled, 
    .btn-signup:disabled {
      background: rgba(255, 255, 255, 0.7);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .signup-link, 
    .login-link {
      margin-top: 1rem;
    }
    
    .error-message {
      color: #ff6b6b;
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: none;
    }
    
    .back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      position: absolute;
      top: 20px;
      left: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      transform: translateX(-3px);
    }
    
    .password-strength {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }
    
    .strength-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      margin-left: 8px;
      flex-grow: 1;
      position: relative;
    }
    
    .strength-bar::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      border-radius: 2px;
      width: 0%;
      background: #ff6b6b;
      transition: all 0.3s ease;
    }
    
    .strength-weak::after {
      width: 33%;
      background: #ff6b6b;
    }
    
    .strength-medium::after {
      width: 66%;
      background: #feca57;
    }
    
    .strength-strong::after {
      width: 100%;
      background: #1dd1a1;
    }
  </style>
</head>
<body>
<div class="bubbles">
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
</div>

<!-- Conteneur de connexion -->
<div class="container visible" id="loginContainer">
    <h1>Propelize</h1>
    <p class="subtitle">Plateforme de gestion de v√©hicules premium</p>
    
    <form class="login-form" id="loginForm">
      <div class="input-group">
        <label for="username">Nom d'utilisateur</label>
        <div class="icon">üë§</div>
        <input type="text" id="username" name="username" placeholder="Votre nom d'utilisateur" required>
      </div>
      
      <div class="input-group">
        <label for="password">Mot de passe</label>
        <div class="icon">üîí</div>
        <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      
      <div class="input-group">
        <label for="role">Vous √™tes:</label>
        <div class="role-icon">üëë</div>
        <select id="role" name="role" required>
          <option value="">S√©lectionnez votre r√¥le</option>
          <option value="admin">Administrateur</option>
          <option value="user">Utilisateur</option>
        </select>
      </div>
      
      <div class="remember-forgot">
        <div class="remember">
          <input type="checkbox" id="remember">
          <label for="remember">Se souvenir de moi</label>
        </div>
        <a href="#" class="forgot-password">Mot de passe oubli√©?</a>
      </div>
      
      <div class="error-message" id="loginError"></div>
      
      <button type="submit" class="btn-login">Se connecter</button>
    </form>
    
    <p class="signup-link">Pas encore inscrit? <a href="#" id="showSignup">Cr√©er un compte</a></p>
</div>

<!-- Conteneur d'inscription -->
<div class="container hidden" id="signupContainer">
    <button class="back-btn" id="backToLogin">‚Üê Retour</button>
    <h1>Cr√©er un compte</h1>
    <p class="subtitle">Rejoignez notre plateforme premium</p>
    
    <form class="signup-form" id="signupForm">
      <div class="input-group">
        <label for="fullname">Nom complet</label>
        <div class="icon">üë§</div>
        <input type="text" id="fullname" name="fullname" placeholder="Votre nom complet" required>
      </div>
      
      <div class="input-group">
        <label for="username">Nom d'utilisateur</label>
        <div class="icon">üë§</div>
        <input type="text" id="signup-username" name="username" placeholder="Choisissez un nom d'utilisateur" required>
      </div>
      
      <div class="input-group">
        <label for="signup-password">Mot de passe</label>
        <div class="icon">üîí</div>
        <input type="password" id="signup-password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        <div class="password-strength">
          S√©curit√©: 
          <span id="strength-text">faible</span>
          <div class="strength-bar strength-weak" id="strength-bar"></div>
        </div>
      </div>
      
      <div class="input-group">
        <label for="confirm-password">Confirmer le mot de passe</label>
        <div class="icon">üîí</div>
        <input type="password" id="confirm-password" name="confirm-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      
      <div class="remember">
        <input type="checkbox" id="terms" required>
        <label for="terms">J'accepte les <a href="#" style="color: white; text-decoration: underline;">termes et conditions</a></label>
      </div>
      
      <div class="error-message" id="signupError"></div>
      
      <button type="submit" class="btn-signup">S'inscrire</button>
    </form>
    
    <p class="login-link">D√©j√† inscrit? <a href="#" id="showLogin">Se connecter</a></p>
</div>

<script>
    // Gestion des formulaires
    document.addEventListener('DOMContentLoaded', function() {
      // √âl√©ments du DOM
      const loginContainer = document.getElementById('loginContainer');
      const signupContainer = document.getElementById('signupContainer');
      const showSignupLink = document.getElementById('showSignup');
      const showLoginLink = document.getElementById('showLogin');
      const backToLoginBtn = document.getElementById('backToLogin');
      const loginError = document.getElementById('loginError');
      const signupError = document.getElementById('signupError');
      const signupPassword = document.getElementById('signup-password');
      const strengthText = document.getElementById('strength-text');
      const strengthBar = document.getElementById('strength-bar');
      
      // Initialisation des bulles
      initBubbles();
      
      // Gestion de l'affichage des formulaires
      function showLogin() {
        loginContainer.classList.remove('hidden');
        loginContainer.classList.add('visible');
        signupContainer.classList.remove('visible');
        signupContainer.classList.add('hidden');
        loginError.style.display = 'none';
      }
      
      function showSignup() {
        signupContainer.classList.remove('hidden');
        signupContainer.classList.add('visible');
        loginContainer.classList.remove('visible');
        loginContainer.classList.add('hidden');
        signupError.style.display = 'none';
      }
      
      // √âv√©nements
      showSignupLink.addEventListener('click', function(e) {
        e.preventDefault();
        showSignup();
      });
      
      showLoginLink.addEventListener('click', function(e) {
        e.preventDefault();
        showLogin();
      });
      
      backToLoginBtn.addEventListener('click', function(e) {
        e.preventDefault();
        showLogin();
      });
      
      // Indicateur de force du mot de passe
      signupPassword.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        
        strengthText.textContent = strength.text;
        strengthBar.className = 'strength-bar ' + strength.class;
      });
      
      // Connexion
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      
      // Inscription
      document.getElementById('signupForm').addEventListener('submit', handleSignup);
    });
    
    // Fonctions utilitaires
    function initBubbles() {
      document.querySelectorAll('.bubble').forEach(bubble => {
        bubble.style.left = Math.random() * 100 + '%';
        bubble.style.animationDuration = (5 + Math.random() * 10) + 's';
        bubble.style.width = (20 + Math.random() * 30) + 'px';
        bubble.style.height = bubble.style.width;
      });
    }
    
    function checkPasswordStrength(password) {
      const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*])(?=.{8,})/;
      const mediumRegex = /^(((?=.*[a-z])(?=.*[A-Z]))|((?=.*[a-z])(?=.*[0-9]))|((?=.*[A-Z])(?=.*[0-9])))(?=.{6,})/;
      
      if (strongRegex.test(password)) {
        return { text: 'fort', class: 'strength-strong' };
      } else if (mediumRegex.test(password)) {
        return { text: 'moyen', class: 'strength-medium' };
      } else {
        return { text: 'faible', class: 'strength-weak' };
      }
    }
    
    function showError(element, message) {
      element.textContent = message;
      element.style.display = 'block';
    }
    
	async function sendRequest(url, method, data) {
	  try {
		const token = localStorage.getItem('authToken');
		const headers = {
		  'Content-Type': 'application/json'
		};
		
		if (token) {
		  headers['Authorization'] = `Bearer ${token}`;
		}
		
		const response = await fetch(url, {
		  method: method,
		  headers: headers,
		  credentials: "include",
		  body: data ? JSON.stringify(data) : undefined
		});
		
		if (response.status === 401) {
		  // Token invalide ou expir√© - d√©connecter l'utilisateur
		  localStorage.removeItem('authToken');
		  localStorage.removeItem('currentUser');
		  window.location.href = 'index.html';
		  throw new Error('Session expir√©e. Veuillez vous reconnecter.');
		}
		
		if (!response.ok) {
		  const errorData = await response.json().catch(() => ({}));
		  throw new Error(errorData.error || 'Erreur serveur');
		}
		
		return await response.json();
	  } catch (error) {
		console.error('Request failed:', error);
		throw error;
	  }
	}
    
    // Gestionnaires d'√©v√©nements
    async function handleLogin(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;
      const btn = document.querySelector('.btn-login');
      const loginError = document.getElementById('loginError');
      
      if (!username || !password || !role) {
        showError(loginError, 'Veuillez remplir tous les champs');
        return;
      }
      
      btn.innerHTML = 'Connexion en cours...';
      btn.disabled = true;
      loginError.style.display = 'none';
      
      try {
        const response = await sendRequest('http://localhost:3001/auth/login', 'POST', {
          name: username,
          password: password
        });
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /*page.on('console', msg => {
        
        	console.log(msg.text());
        
        });
        await page.evaluate(() => {
        
        	console.log(`Le access token est ${response.accessToken} et le refreshToken est ${response.refreshToken}`);
        
        });*/
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////
        
        localStorage.setItem('authToken', response.accessToken);
        localStorage.setItem('currentUser', JSON.stringify(response.user));
        
        // Redirection bas√©e sur le r√¥le
        if (response.user.role === 'admin') {
          window.location.href = 'http://localhost:3000/dashboard-admin.html';
        } else {
          window.location.href = 'http://localhost:3000/dashboard-user.html';
        }
        
      } catch (error) {
        showError(loginError, error.message || 'Erreur lors de la connexion');
      } finally {
        btn.innerHTML = 'Se connecter';
        btn.disabled = false;
      }
    }
    
    async function handleSignup(e) {
      e.preventDefault();
      
      const fullname = document.getElementById('fullname').value;
      const username = document.getElementById('signup-username').value;
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const btn = document.querySelector('.btn-signup');
      const signupError = document.getElementById('signupError');
      
      // Validation
      if (!fullname || !username || !password || !confirmPassword) {
        showError(signupError, 'Veuillez remplir tous les champs');
        return;
      }
      
      if (password !== confirmPassword) {
        showError(signupError, 'Les mots de passe ne correspondent pas');
        return;
      }
      
      if (password.length < 6) {
        showError(signupError, 'Le mot de passe doit contenir au moins 6 caract√®res');
        return;
      }
      
      if (!document.getElementById('terms').checked) {
        showError(signupError, 'Veuillez accepter les termes et conditions');
        return;
      }
      
      btn.innerHTML = 'Inscription en cours...';
      btn.disabled = true;
      signupError.style.display = 'none';
      
      try {
        const response = await sendRequest('http://localhost:3001/auth/register', 'POST', {
          name: username,
          password: password
        });
        
        alert('Inscription r√©ussie ! Vous pouvez maintenant vous connecter.');
        document.getElementById('loginContainer').classList.add('visible');
        document.getElementById('loginContainer').classList.remove('hidden');
        document.getElementById('signupContainer').classList.add('hidden');
        document.getElementById('signupContainer').classList.remove('visible');
        
        // Pr√©-remplir le formulaire de connexion
        document.getElementById('username').value = username;
        document.getElementById('password').value = '';
        
      } catch (error) {
        showError(signupError, error.message || 'Erreur lors de l\'inscription');
      } finally {
        btn.innerHTML = 'S\'inscrire';
        btn.disabled = false;
      }
    }
</script>
</body>
</html>
